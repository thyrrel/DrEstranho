# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
# â”ƒ ğŸ§™ mago_supremo.yml â€“ Orquestra o ciclo completo dos rituais              â”ƒ
# â”ƒ ğŸ“ Executado localmente na branch main                                    â”ƒ
# â”ƒ ğŸ”® byThyrrel | Sem jq | Sem aspas curvas | Sem falhas                     â”ƒ
# â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
name: Mago Supremo

on:
  workflow_dispatch:
    inputs:
      nome:
        description: 'Nome do ritual'
        required: true
        type: string
      destino:
        description: 'Destino dimensional'
        required: true
        type: string

permissions:
  contents: write

jobs:
  criar_ritual:
    name: âœ¨ Criar ritual inicial
    runs-on: ubuntu-latest
    outputs:
      nome: ${{ steps.definir.outputs.nome }}
    steps:
      - name: ğŸ“¦ Checkout do GrimÃ³rio
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ§¾ Criar arquivo ritualÃ­stico
        id: definir
        run: |
          mkdir -p Tutor-DemonÃ­aco/recipes
          echo "nome: ${{ inputs.nome }}" > Tutor-DemonÃ­aco/recipes/${{ inputs.nome }}.txt
          echo "destino: ${{ inputs.destino }}" >> Tutor-DemonÃ­aco/recipes/${{ inputs.nome }}.txt
          echo "nome=${{ inputs.nome }}" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Comitar ritual criado
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "DrEstranho: ritual '${{ inputs.nome }}' criado para '${{ inputs.destino }}'"
          branch: main
          file_pattern: Tutor-DemonÃ­aco/recipes/${{ inputs.nome }}.txt

  acompanhar_fluxo:
    name: ğŸ” Acompanhar fluxo do ritual
    runs-on: ubuntu-latest
    needs: criar_ritual
    steps:
      - name: ğŸ“¦ Checkout do GrimÃ³rio
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ” Verificar presenÃ§a em /rituais/
        run: |
          if [ -f Tutor-DemonÃ­aco/rituais/${{ needs.criar_ritual.outputs.nome }}.dart ]; then
            echo "âœ… Ritual encontrado em /rituais/"
          else
            echo "âŒ Ritual nÃ£o encontrado em /rituais/"
            exit 1
          fi

      - name: ğŸ” Verificar cÃ³pia em LIMBO
        run: |
          if [ -f lib/limbo/${{ needs.criar_ritual.outputs.nome }}.dart ]; then
            echo "âœ… Artefato em teste na dimensÃ£o LIMBO"
          else
            echo "âŒ Artefato nÃ£o chegou em LIMBO"
            exit 1
          fi

  testar_em_limbo:
    name: ğŸ§ª Testar artefato em LIMBO
    runs-on: ubuntu-latest
    needs: acompanhar_fluxo
    steps:
      - name: ğŸ“¦ Checkout do GrimÃ³rio
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ§ª Simular testes dimensionais
        run: |
          echo "ğŸ§ª Testando artefato '${{ needs.criar_ritual.outputs.nome }}'..."
          sleep 2
          echo "âœ… Teste simulado aprovado"

  preparar_matriz:
    name: ğŸ§¾ Preparar matriz de artefatos
    runs-on: ubuntu-latest
    needs: testar_em_limbo
    outputs:
      instrumentos: ${{ steps.instrumentos.outputs.lista }}
      grimorio: ${{ steps.grimorio.outputs.lista }}
      extraplanares: ${{ steps.extraplanares.outputs.lista }}
    steps:
      - name: ğŸ“¦ Checkout do GrimÃ³rio
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ“œ Instrumentos-MÃ¡gicos
        id: instrumentos
        run: |
          mkdir -p Instrumentos-MÃ¡gicos/instrumentos
          # Gera array JSON com awk (sem jq)
          printf '[' > inst.json
          first=1
          for f in Instrumentos-MÃ¡gicos/instrumentos/*.dart; do
            [ -e "$f" ] || continue
            name=$(basename "$f" .dart)
            [ $first -eq 0 ] && printf ',' >> inst.json
            printf '"%s"' "$name" >> inst.json
            first=0
          done
          printf ']' >> inst.json
          echo "lista=$(cat inst.json)" >> $GITHUB_OUTPUT

      - name: ğŸ“œ GRIMORIO
        id: grimorio
        run: |
          mkdir -p GRIMORIO/rituais
          printf '[' > grim.json
          first=1
          for f in GRIMORIO/rituais/*.dart; do
            [ -e "$f" ] || continue
            name=$(basename "$f" .dart)
            [ $first -eq 0 ] && printf ',' >> grim.json
            printf '"%s"' "$name" >> grim.json
            first=0
          done
          printf ']' >> grim.json
          echo "lista=$(cat grim.json)" >> $GITHUB_OUTPUT

      - name: ğŸ“œ ExtraPlanares
        id: extraplanares
        run: |
          mkdir -p ExtraPlanares/extraplanar
          printf '[' > ext.json
          first=1
          for f in ExtraPlanares/extraplanar/*.dart; do
            [ -e "$f" ] || continue
            name=$(basename "$f" .dart)
            [ $first -eq 0 ] && printf ',' >> ext.json
            printf '"%s"' "$name" >> ext.json
            first=0
          done
          printf ']' >> ext.json
          echo "lista=$(cat ext.json)" >> $GITHUB_OUTPUT

  invocar_instrumentos:
    name: ğŸª„ Instrumentos-MÃ¡gicos
    runs-on: ubuntu-latest
    needs: preparar_matriz
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.preparar_matriz.outputs.instrumentos) }}
    steps:
      - name: ğŸ”” Invocar ${{ matrix.artefato }}
        run: echo "ğŸ”” Artefato '${{ matrix.artefato }}' invocado da dimensÃ£o Instrumentos-MÃ¡gicos"

  invocar_grimorio:
    name: ğŸ“– GRIMORIO
    runs-on: ubuntu-latest
    needs: preparar_matriz
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.preparar_matriz.outputs.grimorio) }}
    steps:
      - name: ğŸ”” Invocar ${{ matrix.artefato }}
        run: echo "ğŸ”” Artefato '${{ matrix.artefato }}' invocado da dimensÃ£o GRIMORIO"

  invocar_extraplanares:
    name: ğŸŒŒ ExtraPlanares
    runs-on: ubuntu-latest
    needs: preparar_matriz
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.preparar_matriz.outputs.extraplanares) }}
    steps:
      - name: ğŸ”” Invocar ${{ matrix.artefato }}
        run: echo "ğŸ”” Artefato '${{ matrix.artefato }}' invocado da dimensÃ£o ExtraPlanares"
