# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
# â”ƒ ğŸ§™ mago_supremo.yml â€“ Orquestra criaÃ§Ã£o e invocaÃ§Ã£o de rituais            â”ƒ
# â”ƒ ğŸ“ Roda na MAIN | Sem shell | Sem txt | API GitHub | Jobs com NOME real   â”ƒ
# â”ƒ ğŸ”® byThyrrel | Sem aspas curvas | Sem comandos incompatÃ­veis              â”ƒ
# â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
name: Mago Supremo

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Cole o conteÃºdo do ritual (serÃ¡ o .dart)"
        required: true
        type: string
      destino:
        description: "DimensÃ£o final (Instrumentos, GRIMORIO, ExtraPlanares)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  criar_ritual:
    name: âœ¨ Criar artefato .dart
    runs-on: ubuntu-latest
    outputs:
      nome: ${{ steps.criar.outputs.nome }}
    steps:
      - name: ğŸ“œ Criar .dart via API (popup â†’ branch Tutor-DemonÃ­aco)
        id: criar
        uses: actions/github-script@v7
        with:
          script: |
            const prompt = `${{ inputs.prompt }}`;
            const destino = '${{ inputs.destino }}';
            const nome    = 'ritual_' + Math.random().toString(36).slice(2);
            const code    = `// Ritual: ${nome}\n${prompt}\nvoid main() => print("${nome} -> ${destino}");`;
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `Tutor-DemonÃ­aco/rituais/${nome}.dart`,
              message: `Mago: artefato ${nome} criado para ${destino}`,
              content: Buffer.from(code).toString('base64'),
              branch: 'Tutor-DemonÃ­aco'
            });
            core.setOutput('nome', nome);

  acompanhar_fluxo:
    name: ğŸ” Acompanhar fluxo do artefato
    needs: criar_ritual
    outputs:
      aprovado: ${{ steps.teste.outputs.aprovado }}
    steps:
      - name: â³ Aguardar chegada em /rituais/ (poll)
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ needs.criar_ritual.outputs.nome }}';
            let tentativas = 0;
            while (tentativas < 30) {
              try {
                await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: `Tutor-DemonÃ­aco/rituais/${nome}.dart`,
                  ref: 'main'
                });
                core.info(`âœ… ${nome} chegou em /rituais/`);
                break;
              } catch (e) {
                core.info(`â³ Aguardando ${nome} em /rituais/...`);
                await new Promise(r => setTimeout(r, 10000));
                tentativas++;
              }
            }
            if (tentativas === 30) core.setFailed(`âŒ ${nome} nÃ£o chegou em /rituais/`);

      - name: ğŸ“¦ Mover cÃ³pia para LIMBO/lib/limbo/
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ needs.criar_ritual.outputs.nome }}';
            const { data: original } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `Tutor-DemonÃ­aco/rituais/${nome}.dart`,
              ref: 'main'
            });
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `lib/limbo/${nome}.dart`,
              message: `Mago: ${nome} movido para LIMBO`,
              content: original.content,
              branch: 'LIMBO'
            });

      - name: âœ… Testar (sempre aprova)
        id: teste
        run: echo "âœ… Teste simulado aprovado para ${{ needs.criar_ritual.outputs.nome }}"

  listar_dimensoes:
    name: ğŸ“œ Listar artefatos selados
    needs: acompanhar_fluxo
    if: always()
    outputs:
      instrumentos: ${{ steps.listas.outputs.instrumentos }}
      grimorio: ${{ steps.listas.outputs.grimorio }}
      extraplanares: ${{ steps.listas.outputs.extraplanares }}
    steps:
      - name: ğŸ“š Listar .dart por dimensÃ£o
        id: listas
        uses: actions/github-script@v7
        with:
          script: |
            async function listar(path, output) {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path,
                  ref: 'main'
                });
                const nomes = Array.isArray(data)
                  ? data.filter(f => f.name.endsWith('.dart')).map(f => f.name.replace('.dart', ''))
                  : [];
                core.setOutput(output, JSON.stringify(nomes));
              } catch {
                core.setOutput(output, JSON.stringify([]));
              }
            }
            await listar('Instrumentos-Magicos/instrumentos', 'instrumentos');
            await listar('GRIMORIO/rituais', 'grimorio');
            await listar('ExtraPlanares/extraplanar', 'extraplanares');

  invocar_instrumentos:
    name: ğŸª„ Instrumentos-MÃ¡gicos
    needs: listar_dimensoes
    if: fromJson(needs.listar_dimensoes.outputs.instrumentos)[0]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.instrumentos) }}
    steps:
      - name: ğŸ”” Invocar ${{ matrix.artefato }}
        uses: actions/github-script@v7
        with:
          script: |
            core.info(`ğŸ”” Artefato '${{ matrix.artefato }}' pronto para invocaÃ§Ã£o`);

  invocar_grimorio:
    name: ğŸ“– GRIMORIO
    needs: listar_dimensoes
    if: fromJson(needs.listar_dimensoes.outputs.grimorio)[0]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.grimorio) }}
    steps:
      - name: ğŸ”” Invocar ${{ matrix.artefato }}
        uses: actions/github-script@v7
        with:
          script: |
            core.info(`ğŸ”” Artefato '${{ matrix.artefato }}' pronto para invocaÃ§Ã£o`);

  invocar_extraplanares:
    name: ğŸŒŒ ExtraPlanares
    needs: listar_dimensoes
    if: fromJson(needs.listar_dimensoes.outputs.extraplanares)[0]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.extraplanares) }}
    steps:
      - name: ğŸ”” Invocar ${{ matrix.artefato }}
        uses: actions/github-script@v7
        with:
          script: |
            core.info(`ğŸ”” Artefato '${{ matrix.artefato }}' pronto para invocaÃ§Ã£o`);
