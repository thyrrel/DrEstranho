# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ 🧙‍♂️ mago_supremo.yml - Orquestra o ciclo completo dos rituais       ┃
# ┃ 📍 Executado localmente na branch main                                ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

name: Mago Supremo

on:
  workflow_dispatch:
    inputs:
      nome:
        description: 'Nome do ritual'
        required: true
        type: string
      destino:
        description: 'Destino dimensional'
        required: true
        type: string

jobs:
  criar_ritual:
    name: ✨ Criar ritual inicial
    runs-on: ubuntu-latest
    outputs:
      nome: ${{ steps.definir.outputs.nome }}
    steps:
      - name: 📦 Checkout do Grimório
        uses: actions/checkout@v3

      - name: 🧾 Criar arquivo ritualístico
        id: definir
        run: |
          mkdir -p Tutor-Demoníaco/recipes
          echo "nome: ${{ inputs.nome }}" > Tutor-Demoníaco/recipes/${{ inputs.nome }}.txt
          echo "destino: ${{ inputs.destino }}" >> Tutor-Demoníaco/recipes/${{ inputs.nome }}.txt
          echo "nome=${{ inputs.nome }}" >> $GITHUB_OUTPUT

      - name: 📤 Comitar ritual criado
        run: |
          git config --global user.name "DrEstranho"
          git config --global user.email "magus@vdf.com"
          git add Tutor-Demoníaco/recipes/${{ inputs.nome }}.txt
          git commit -m "DrEstranho: ritual '${{ inputs.nome }}' criado para '${{ inputs.destino }}'"
          git push

  acompanhar_fluxo:
    name: 🔍 Acompanhar fluxo do ritual
    runs-on: ubuntu-latest
    needs: criar_ritual
    steps:
      - name: 📦 Checkout do Grimório
        uses: actions/checkout@v3

      - name: 🔍 Verificar presença em /rituais/
        run: |
          if [ -f Tutor-Demoníaco/rituais/${{ needs.criar_ritual.outputs.nome }}.dart ]; then
            echo "✅ Ritual encontrado em /rituais/"
          else
            echo "❌ Ritual não encontrado em /rituais/"
            exit 1
          fi

      - name: 🔍 Verificar cópia em LIMBO
        run: |
          if [ -f lib/limbo/${{ needs.criar_ritual.outputs.nome }}.dart ]; then
            echo "✅ Artefato em teste na dimensão LIMBO"
          else
            echo "❌ Artefato não chegou em LIMBO"
            exit 1
          fi

  testar_em_limbo:
    name: 🧪 Testar artefato em LIMBO
    runs-on: ubuntu-latest
    needs: acompanhar_fluxo
    steps:
      - name: 📦 Checkout do Grimório
        uses: actions/checkout@v3

      - name: 🧪 Simular testes dimensionais
        run: |
          echo "🧪 Testando artefato '${{ needs.criar_ritual.outputs.nome }}'..."
          sleep 2
          echo "✅ Teste simulado aprovado"

  preparar_matriz:
    name: 🧾 Preparar matriz de artefatos
    runs-on: ubuntu-latest
    needs: testar_em_limbo
    outputs:
      instrumentos: ${{ steps.instrumentos.outputs.lista }}
      grimorio: ${{ steps.grimorio.outputs.lista }}
      extraplanares: ${{ steps.extraplanares.outputs.lista }}
    steps:
      - name: 📦 Checkout do Grimório
        uses: actions/checkout@v3

      - name: 📜 Instrumentos-Mágicos
        id: instrumentos
        run: |
          lista=$(ls Instrumentos-Mágicos/instrumentos | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "lista=$lista" >> $GITHUB_OUTPUT

      - name: 📜 GRIMORIO
        id: grimorio
        run: |
          lista=$(ls GRIMORIO/rituais | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "lista=$lista" >> $GITHUB_OUTPUT

      - name: 📜 ExtraPlanares
        id: extraplanares
        run: |
          lista=$(ls ExtraPlanares/extraplanare | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "lista=$lista" >> $GITHUB_OUTPUT

  invocar_instrumentos:
    name: 🪄 Instrumentos-Mágicos
    runs-on: ubuntu-latest
    needs: preparar_matriz
    strategy:
      matrix:
        artefato: ${{ fromJson(needs.preparar_matriz.outputs.instrumentos) }}
    steps:
      - name: 🔔 Invocar ${{ matrix.artefato }}
        run: echo "🔔 Artefato '${{ matrix.artefato }}' invocado da dimensão Instrumentos-Mágicos"

  invocar_grimorio:
    name: 📖 GRIMORIO
    runs-on: ubuntu-latest
    needs: preparar_matriz
    strategy:
      matrix:
        artefato: ${{ fromJson(needs.preparar_matriz.outputs.grimorio) }}
    steps:
      - name: 🔔 Invocar ${{ matrix.artefato }}
        run: echo "🔔 Artefato '${{ matrix.artefato }}' invocado da dimensão GRIMORIO"

  invocar_extraplanares:
    name: 🌌 ExtraPlanares
    runs-on: ubuntu-latest
    needs: preparar_matriz
    strategy:
      matrix:
        artefato: ${{ fromJson(needs.preparar_matriz.outputs.extraplanares) }}
    steps:
      - name: 🔔 Invocar ${{ matrix.artefato }}
        run: echo "🔔 Artefato '${{ matrix.artefato }}' invocado da dimensão ExtraPlanares"
