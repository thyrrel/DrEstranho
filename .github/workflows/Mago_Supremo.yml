# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
# â”ƒ ğŸ§™ mago_supremo.yml - Ritual de invocaÃ§Ã£o via bin/*.dart                   â”ƒ
# â”ƒ ğŸ“ Puxa artefato de bin/ | Observa Tutor-Demoniaco | Testa em LIMBO       â”ƒ
# â”ƒ ğŸ”® byThyrrel | GitHub Web | Estilo dimensional puro                       â”ƒ
# â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

name: Mago Supremo

on:
  workflow_dispatch:
    inputs:
      invocacao:
        description: "ğŸª„ Nome do artefato (sem .dart)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  ler_bin:
    name: "ğŸ“¥ Ler bin/${{ github.event.inputs.invocacao }}.dart"
    runs-on: ubuntu-latest
    outputs:
      nome: ${{ steps.extrair.outputs.nome }}
      prompt: ${{ steps.extrair.outputs.prompt }}
    steps:
      - name: ğŸ” Extrair conteÃºdo do bin/
        id: extrair
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ github.event.inputs.invocacao }}';
            const path = `bin/${nome}.dart`;
            const { data } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path,
              ref: 'main'
            });
            const prompt = Buffer.from(data.content, 'base64').toString();
            core.setOutput('nome', nome);
            core.setOutput('prompt', prompt);

  criar_txt:
    name: "ğŸ“œ Criar recipes/${{ needs.ler_bin.outputs.nome }}.txt"
    runs-on: ubuntu-latest
    needs: ler_bin
    steps:
      - name: âœï¸ Criar .txt na branch Tutor-Demoniaco
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ needs.ler_bin.outputs.nome }}';
            const prompt = `${{ needs.ler_bin.outputs.prompt }}`;
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipes/${nome}.txt`,
              message: `ğŸ“œ Recipe criada para ${nome}`,
              content: Buffer.from(prompt).toString('base64'),
              branch: 'Tutor-Demoniaco'
            });

  criar_dart:
    name: "âœ¨ Criar rituais/${{ needs.ler_bin.outputs.nome }}.dart"
    runs-on: ubuntu-latest
    needs: criar_txt
    steps:
      - name: ğŸ§ª Criar .dart na branch Tutor-Demoniaco
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ needs.ler_bin.outputs.nome }}';
            const prompt = `${{ needs.ler_bin.outputs.prompt }}`;
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `rituais/${nome}.dart`,
              message: `âœ¨ Ritual criado: ${nome}.dart`,
              content: Buffer.from(prompt).toString('base64'),
              branch: 'Tutor-Demoniaco'
            });

  mover_limbo:
    name: "ğŸ“¦ Mover para LIMBO"
    runs-on: ubuntu-latest
    needs: criar_dart
    steps:
      - name: ğŸšª Copiar para lib/limbo/ na branch LIMBO
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ needs.ler_bin.outputs.nome }}';
            const { data: original } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `rituais/${nome}.dart`,
              ref: 'Tutor-Demoniaco'
            });
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `lib/limbo/${nome}.dart`,
              message: `ğŸŒŒ Artefato ${nome} movido para LIMBO`,
              content: original.content,
              branch: 'LIMBO'
            });

  testar_limbo:
    name: "âœï¸ Testar LIMBO"
    runs-on: ubuntu-latest
    needs: mover_limbo
    outputs:
      aprovado: ${{ steps.teste.outputs.aprovado }}
    steps:
      - id: teste
        run: |
          nome="${{ needs.ler_bin.outputs.nome }}"
          if [[ "$nome" == "falha" ]]; then
            echo "aprovado=false" >> $GITHUB_OUTPUT
            echo "::error::âŒ Falha na invocaÃ§Ã£o: artefato nÃ£o aprovado"
            exit 1
          else
            echo "aprovado=true" >> $GITHUB_OUTPUT
            echo "âœ… Artefato em LIMBO aprovado"
          fi

  listar_dimensoes:
    name: "ğŸŒŒ Listar dimensÃµes"
    runs-on: ubuntu-latest
    needs: testar_limbo
    if: needs.testar_limbo.outputs.aprovado == 'true'
    outputs:
      instrumentos: ${{ steps.list.outputs.instrumentos }}
      grimorio: ${{ steps.list.outputs.grimorio }}
      extraplanares: ${{ steps.list.outputs.extraplanares }}
    steps:
      - id: list
        uses: actions/github-script@v7
        with:
          script: |
            async function listDim(path) {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path,
                  ref: 'main'
                });
                return Array.isArray(data) ? data.filter(f => f.name.endsWith('.dart')).map(f => f.name.replace('.dart','')) : [];
              } catch {
                return [];
              }
            }

            core.setOutput('instrumentos', JSON.stringify(await listDim('Instrumentos-Magicos/instrumentos')));
            core.setOutput('grimorio', JSON.stringify(await listDim('GRIMORIO/rituais')));
            core.setOutput('extraplanares', JSON.stringify(await listDim('ExtraPlanares/extraplanar')));

  instrumentos:
    name: "ğŸ¶ Instrumentos-Magicos"
    runs-on: ubuntu-latest
    needs: listar_dimensoes
    if: ${{ fromJson(needs.listar_dimensoes.outputs.instrumentos) != '[]' }}
    strategy:
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.instrumentos) }}
    steps:
      - run: echo "ğŸµ Artefato '${{ matrix.artefato }}' pronto para invocaÃ§Ã£o"

  grimorio:
    name: "ğŸ“– GRIMORIO"
    runs-on: ubuntu-latest
    needs: listar_dimensoes
    if: ${{ fromJson(needs.listar_dimensoes.outputs.grimorio) != '[]' }}
    strategy:
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.grimorio) }}
    steps:
      - run: echo "ğŸ“œ Artefato '${{ matrix.artefato }}' pronto para invocaÃ§Ã£o"

  extraplanares:
    name: "ğŸª ExtraPlanares"
    runs-on: ubuntu-latest
    needs: listar_dimensoes
    if: ${{ fromJson(needs.listar_dimensoes.outputs.extraplanares) != '[]' }}
    strategy:
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.extraplanares) }}
    steps:
      - run: echo "ğŸŒŒ Artefato '${{ matrix.artefato }}' pronto para invocaÃ§Ã£o"
