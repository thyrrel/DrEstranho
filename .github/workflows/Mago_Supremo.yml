# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
# â”ƒ ðŸ§™ mago_supremo.yml â€“ Ritual completo                                      â”ƒ
# â”ƒ ðŸ”® Entrada â†’ recipes â†’ rituais â†’ LIMBO â†’ Teste â†’ DimensÃµes finais          â”ƒ
# â”ƒ ðŸ“ Tutor-DemonÃ­aco | LIMBO | Instrumentos-MÃ¡gicos | GRIMORIO | ExtraPlanares â”ƒ
# â”ƒ byThyrrel                                                                  â”ƒ
# â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
name: Mago Supremo

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Cole o prompt para gerar o artefato"
        required: true
        default: "NomeDoArtefato"

permissions:
  contents: write

jobs:
  inicio:
    name: âœ¨ InÃ­cio do Ritual
    runs-on: ubuntu-latest
    outputs:
      artefato: ${{ steps.define.outputs.artefato }}
    steps:
      - name: Definir nome do artefato
        id: define
        run: |
          nome="${{ github.event.inputs.prompt }}"
          echo "artefato=$nome" >> $GITHUB_OUTPUT

      - name: Criar recipe .txt em Tutor-DemonÃ­aco
        uses: actions/github-script@v7
        with:
          script: |
            const nome = process.env.artefato;
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipes/${nome}.txt`,
              message: `ðŸ“œ Recipe criada para ${nome}`,
              content: Buffer.from(`Prompt para ${nome}`).toString('base64'),
              branch: 'Tutor-DemonÃ­aco'
            });

      - name: Criar ritual .dart em Tutor-DemonÃ­aco/rituais
        uses: actions/github-script@v7
        with:
          script: |
            const nome = process.env.artefato;
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `Tutor-DemonÃ­aco/rituais/${nome}.dart`,
              message: `âœ¨ Ritual criado: ${nome}.dart`,
              content: Buffer.from(`// Ritual gerado para ${nome}`).toString('base64'),
              branch: 'Tutor-DemonÃ­aco'
            });
        env:
          artefato: ${{ steps.define.outputs.artefato }}

  mover_limbo:
    name: ðŸ“¦ Mover para LIMBO
    runs-on: ubuntu-latest
    needs: inicio
    steps:
      - name: Copiar para lib/limbo na branch LIMBO
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ needs.inicio.outputs.artefato }}';
            const { data: original } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `Tutor-DemonÃ­aco/rituais/${nome}.dart`,
              ref: 'Tutor-DemonÃ­aco'
            });
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `lib/limbo/${nome}.dart`,
              message: `ðŸ”® Artefato ${nome} movido para LIMBO`,
              content: original.content,
              branch: 'LIMBO'
            });

  testar_limbo:
    name: ðŸ§ª Testar LIMBO
    runs-on: ubuntu-latest
    needs: mover_limbo
    steps:
      - name: Simular teste (sempre aprova)
        run: echo "âœ… Artefato em LIMBO aprovado"

  listar_dimensoes:
    name: ðŸŒŒ Listar dimensÃµes
    runs-on: ubuntu-latest
    needs: testar_limbo
    outputs:
      instrumentos: ${{ steps.list.outputs.instrumentos }}
      grimorio: ${{ steps.list.outputs.grimorio }}
      extraplanares: ${{ steps.list.outputs.extraplanares }}
    steps:
      - id: list
        uses: actions/github-script@v7
        with:
          script: |
            async function listDim(path) {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path,
                  ref: 'main'
                });
                return Array.isArray(data) ? data.filter(f => f.name.endsWith('.dart')).map(f => f.name.replace('.dart','')) : [];
              } catch {
                return [];
              }
            }
            core.setOutput('instrumentos', JSON.stringify(await listDim('Instrumentos-Magicos/instrumentos')));
            core.setOutput('grimorio', JSON.stringify(await listDim('GRIMORIO/rituais')));
            core.setOutput('extraplanares', JSON.stringify(await listDim('ExtraPlanares/extraplanar')));

  instrumentos:
    name: ðŸŽ¶ Instrumentos-MÃ¡gicos
    runs-on: ubuntu-latest
    needs: listar_dimensoes
    if: fromJson(needs.listar_dimensoes.outputs.instrumentos)[0]
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.instrumentos) }}
    steps:
      - run: echo "ðŸŽµ Artefato ${{ matrix.artefato }} pronto!"

  grimorio:
    name: ðŸ“– GRIMORIO
    runs-on: ubuntu-latest
    needs: listar_dimensoes
    if: fromJson(needs.listar_dimensoes.outputs.grimorio)[0]
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.grimorio) }}
    steps:
      - run: echo "ðŸ“œ Artefato ${{ matrix.artefato }} pronto!"

  extraplanares:
    name: ðŸŒ  ExtraPlanares
    runs-on: ubuntu-latest
    needs: listar_dimensoes
    if: fromJson(needs.listar_dimensoes.outputs.extraplanares)[0]
    strategy:
      fail-fast: false
      matrix:
        artefato: ${{ fromJson(needs.listar_dimensoes.outputs.extraplanares) }}
    steps:
      - run: echo "ðŸŒŒ Artefato ${{ matrix.artefato }} pronto!"
