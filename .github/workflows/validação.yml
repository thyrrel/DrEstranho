# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ 🔮 limbo.yml – Detecta **presença** de lib/limbo/*.dart (não só diff)       ┃
# ┃ 📜 byThyrrel | Sem skip | Valida → infernus ou aprova                       ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
name: Validação Ritual

on:
  push:
    branches: [LIMBO]
    paths: [lib/limbo/*.dart]

permissions:
  contents: write

jobs:
  chegada:
    name: Chegada
    runs-on: ubuntu-latest
    steps:
      - name: Checkout LIMBO
        uses: actions/checkout@v4
        with:
          ref: LIMBO

      - name: Instalar Dart
        uses: dart-lang/setup-dart@v1

      - name: Detectar artefatos **presentes** (não apenas diff)
        id: detect
        run: |
          # Lista TODOS os .dart que estão em lib/limbo/ **agora**
          mapfile -t files < <(find lib/limbo -maxdepth 1 -type f -name '*.dart' 2>/dev/null)
          [ ${#files[@]} -eq 0 ] && echo "Nenhum artefato em lib/limbo/" && exit 0
          printf '%s\n' "${files[@]}" > artefatos.txt
          echo "Artefatos detectados:"
          cat artefatos.txt

      - name: Validar artefato
        run: |
          while IFS= read -r f; do
            [ -f "$f" ] || continue
            echo "🔍 Analisando $f"
            if ! dart analyze --fatal-infos "$f"; then
              echo "❌ $f falhou – movendo para infernus"
              mv "$f" lib/infernus/
              nome=$(basename "$f" .dart)
              echo "- $nome (infernus: $(date))" >> README.md
            else
              echo "✅ $f aprovado"
            fi
          done < artefatos.txt

      - name: Commitar resultados
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '🔮 Limbo: validação concluída'
          branch: LIMBO
