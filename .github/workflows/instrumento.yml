# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ 🔮 instrumento.yml – Ritual de DrEstranho (branch main)                    ┃
# ┃ 📜 Invoca artefatos em instrumentos/, registra no README.md               ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
name: Instrumento Ritual

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - instrumentos/*.dart
      - .github/workflows/instrumento.yml

permissions:
  contents: write

jobs:
  execucao:
    name: Execucao Instrumento
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Instalar Dart
        uses: dart-lang/setup-dart@v1

      - name: Detectar instrumentos
        run: |
          echo "=== Instrumentos detectados ==="
          find instrumentos -maxdepth 1 -type f -name '*.dart' | sort
          echo "==============================="

      - name: Invocar instrumento
        run: |
          ultimo=$(find instrumentos -maxdepth 1 -type f -name '*.dart' | sort | tail -n 1)
          echo "✨ Invocando: $ultimo"
          dart run "$ultimo" || echo "// falha ignorada"

      - name: Upload do artefato invocado
        uses: actions/upload-artifact@v4
        with:
          name: instrumento-${{ github.sha }}
          path: instrumentos/
          retention-days: 1

      - name: Registrar no README
        run: |
          nome=$(find instrumentos -maxdepth 1 -type f -name '*.dart' | sort | tail -n 1 | xargs basename | sed 's/.dart$//')
          echo "- $nome" >> README.md

      - name: Commit automatico
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Instrumento invocado por DrEstranho"
          branch: main
          file_pattern: README.md
          commit_user_name: ritual-bot
          commit_user_email: ritual@bot.com
