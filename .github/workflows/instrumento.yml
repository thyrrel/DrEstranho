# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ 🔮 instrumentos-magicos.yml – Ritual da branch Instrumentos-Mágicos        ┃
# ┃ 📜 Invoca artefatos em instrumentos/, registra no README.md               ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
name: Instrumentos Mágicos

on:
  workflow_dispatch:
  push:
    branches: [Instrumentos-Mágicos]
    paths:
      - instrumentos/*.dart
      - .github/workflows/instrumentos-magicos.yml

permissions:
  contents: write

jobs:
  execucao:
    name: Execução de Instrumento
    runs-on: ubuntu-latest
    steps:
      - name: Checkout da branch Instrumentos-Mágicos
        uses: actions/checkout@v4
        with:
          ref: Instrumentos-Mágicos

      - name: Instalar Dart
        uses: dart-lang/setup-dart@v1

      - name: Detectar instrumentos
        run: |
          echo "=== Instrumentos detectados ==="
          find instrumentos -maxdepth 1 -type f -name '*.dart' | sort
          echo "==============================="

      - name: Invocar último instrumento
        run: |
          ultimo=$(find instrumentos -maxdepth 1 -type f -name '*.dart' | sort | tail -n 1)
          echo "✨ Invocando: $ultimo"
          dart run "$ultimo" || echo "// falha ignorada"

      - name: Registrar no README.md
        run: |
          nome=$(basename $(find instrumentos -maxdepth 1 -type f -name '*.dart' | sort | tail -n 1) .dart)
          sed -i "/## Instrumentos/a - $nome" README.md

      - name: Commit automático
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Instrumento invocado: $nome"
          branch: Instrumentos-Mágicos
          file_pattern: README.md
          commit_user_name: ritual-bot
          commit_user_email: ritual@bot.com
