# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ 🔮 instrumento.yml – Recebe, executa e armazena artefatos em instrumento/  ┃
# ┃ 📜 byThyrrel | Sem aspas curvas | Sem caracteres especiais                 ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
name: Instrumento Ritual

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - instrumento/*.dart
      - .github/workflows/instrumento.yml

permissions:
  contents: write

jobs:
  execucao:
    name: Execucao Instrumento
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Instalar Dart
        uses: dart-lang/setup-dart@v1

      - name: Detectar artefatos em instrumento
        run: |
          echo "=== Artefatos em instrumento/ ==="
          find instrumento -maxdepth 1 -type f -name '*.dart' 2>/dev/null | sort
          echo "================================="

      - name: Garantir executaveis
        run: |
          mkdir -p bin
          [ -f bin/ritualico.dart ] || echo "// instrumento" > bin/ritualico.dart

      - name: Executar ritualico
        run: dart run bin/ritualico.dart || echo "// falha ignorada"

      - name: Upload do artefato processado
        uses: actions/upload-artifact@v4
        with:
          name: instrumento-${{ github.sha }}
          path: instrumento/
          retention-days: 1

      - name: Adicionar nome ao README
        run: |
          ultimo=$(find instrumento -maxdepth 1 -type f -name '*.dart' | sort | tail -n 1)
          nome=$(basename "$ultimo" .dart)
          echo "- $nome" >> README.md

      - name: Commit automatico
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Instrumento: nome registrado"
          branch: main
          file_pattern: README.md
          commit_user_name: ritual-bot
          commit_user_email: ritual@bot.com
