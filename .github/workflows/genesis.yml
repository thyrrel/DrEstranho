# ‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì
# ‚îÉ üîÆ genesis.yml ‚Äì Ritual por ritual: artefato nomeado pelo .txt real         ‚îÉ
# ‚îÉ üìú byThyrrel | Jobs: Cria√ß√£o, Teleporte, Or√°culo, Selo, Ascens√£o          ‚îÉ
# ‚îÉ üßô Checkout primeiro | awk nativo | Sem jq | Sem erros vazios              ‚îÉ
# ‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ
name: Genesis Ritual

on:
  push:
    branches: [Tutor-Demon√≠aco]
    paths: [recipe/**, bin/genesis.dart, .github/workflows/genesis.yml]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  criacao:
    name: Cria√ß√£o
    runs-on: ubuntu-latest
    outputs:
      rituais: ${{ steps.set.outputs.rituais }}
    steps:
      - name: Checkout da branch Tutor-Demon√≠aco
        uses: actions/checkout@v4
        with:
          ref: Tutor-Demon√≠aco

      - name: Listar rituais .txt reais
        id: set
        run: |
          echo "=== Arquivos .txt encontrados ==="
          ls -la recipe/*.txt 2>/dev/null || echo "NENHUM .txt encontrado"
          echo "================================="
          printf '[' > rituais.json
          first=1
          for f in recipe/*.txt; do
            [ -e "$f" ] || continue
            name=$(basename "$f" .txt)
            [ $first -eq 0 ] && printf ',' >> rituais.json
            printf '"%s"' "$name" >> rituais.json
            first=0
          done
          printf ']' >> rituais.json
          echo "Conte√∫do final:" && cat rituais.json
          echo "rituais=$(cat rituais.json)" >> $GITHUB_OUTPUT

  teleporte:
    name: Teleporte
    needs: criacao
    if: needs.criacao.outputs.rituais != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - name: Checkout da branch Tutor-Demon√≠aco
        uses: actions/checkout@v4
        with:
          ref: Tutor-Demon√≠aco

      - name: Instalar Dart
        uses: dart-lang/setup-dart@v1

      - name: Invocar rituais
        run: dart pub get && dart run bin/genesis.dart

      - name: Upload artefato na PASTA rituais/
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: rituais/${{ matrix.ritual }}.dart
          retention-days: 1
          if-no-files-found: error

  oraculo:
    name: Or√°culo
    needs: [criacao, teleporte]
    if: needs.criacao.outputs.rituais != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - name: Checkout da branch LIMBO
        uses: actions/checkout@v4
        with:
          ref: LIMBO
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Baixar artefato real
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: lib/limbo/

      - name: Validar e mover falhos
        run: |
          mkdir -p lib/infernus
          if ! dart analyze --fatal-infos lib/limbo/${{ matrix.ritual }}.dart; then
            cp lib/limbo/${{ matrix.ritual }}.dart lib/infernus/
            git config user.name "ritual-bot"
            git config user.email "ritual@bot.com"
            git add lib/infernus/${{ matrix.ritual }}.dart
            echo "- ${{ matrix.ritual }} (falha: $(date))" >> README.md
            git add README.md
            git commit -m "‚ö†Ô∏è ${{ matrix.ritual }} enviado ao infernus"
            git push origin LIMBO
          fi
      - name: Renomear original para _infernus em Tutor-Demon√≠aco
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ matrix.ritual }}';
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}_infernus`,
              message: `‚ö†Ô∏è ${nome} marcado como infernus`,
              content: Buffer.from('').toString('base64'),
              branch: 'Tutor-Demon√≠aco'
            });
            const { data: txt } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}.txt`,
              ref: 'Tutor-Demon√≠aco'
            });
            await github.rest.repos.deleteFile({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}.txt`,
              message: `üóëÔ∏è ${nome}.txt removido (infernus)`,
              branch: 'Tutor-Demon√≠aco',
              sha: txt.sha
            });

  selo:
    name: Selo
    needs: oraculo
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - name: Checkout da branch Tutor-Demon√≠aco
        uses: actions/checkout@v4
        with:
          ref: Tutor-Demon√≠aco

      - name: Baixar artefato real
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: rituais/

      - name: Definir branch destino pelo conte√∫do do .txt
        id: tipo
        run: |
          tipo=$(head -n1 recipe/${{ matrix.ritual }}.txt | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z]//g')
          case "$tipo" in
            instrumento|instrumentos|magicos) echo "branch=Instrumentos-M√°gicos" ;;
            grimorio|grimoÃÅrio|magia)        echo "branch=GRIMORIO"           ;;
            extraplanar|extraplanares)       echo "branch=ExtraPlanares"       ;;
            *)                               echo "branch=Instrumentos-M√°gicos" ;;
          esac >> $GITHUB_OUTPUT

      - name: Mover artefato para branch respectiva
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const nome   = '${{ matrix.ritual }}';
            const branch = '${{ steps.tipo.outputs.branch }}';
            const content= fs.readFileSync(`rituais/${nome}.dart`, 'utf8');
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `${nome}.dart`,
              message: `‚úÖ Selo: ${nome} promovido para ${branch}`,
              content: Buffer.from(content).toString('base64'),
              branch: branch
            });

      - name: Mover .txt para recipes/acervo (sem extens√£o)
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ matrix.ritual }}';
            const { data: txt } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}.txt`,
              ref: 'Tutor-Demon√≠aco'
            });
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipes/acervo/${nome}`,
              message: `üì¶ ${nome} arquivado em acervo`,
              content: txt.content,
              branch: 'Tutor-Demon√≠aco'
            });
            await github.rest.repos.deleteFile({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}.txt`,
              message: `üóëÔ∏è ${nome}.txt movido para acervo`,
              branch: 'Tutor-Demon√≠aco',
              sha: txt.sha
            });

  ascensao:
    name: Ascens√£o
    needs: selo
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - name: Checkout Tutor-Demon√≠aco
        uses: actions/checkout@v4
        with:
          ref: Tutor-Demon√≠aco

      - name: Registro em Tutor-Demon√≠aco
        run: echo "- ${{ matrix.ritual }}" >> README.md

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '‚úÖ Ascens√£o: ${{ matrix.ritual }} registrado'
          branch: Tutor-Demon√≠aco

      - name: Checkout LIMBO
        uses: actions/checkout@v4
        with:
          ref: LIMBO

      - name: Registro em LIMBO
        run: echo "- ${{ matrix.ritual }} ‚Äì plugin funcional" >> README.md

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '‚úÖ Ascens√£o: ${{ matrix.ritual }} descri√ß√£o adicionada'
          branch: LIMBO
