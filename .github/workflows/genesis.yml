name: Genesis Ritual

on:
  push:
    branches: [Tutor-Demon√≠aco]
    paths: [recipe/**, bin/genesis.dart, .github/workflows/genesis.yml]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  criacao:
    name: Cria√ß√£o
    runs-on: ubuntu-latest
    outputs:
      rituais: ${{ steps.set.outputs.rituais }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Tutor-Demon√≠aco
      - id: set
        run: |
          printf '[' > rituais.json
          first=1
          for f in recipe/*.txt; do
            [ -e "$f" ] || continue
            name=$(basename "$f" .txt)
            [ $first -eq 0 ] && printf ',' >> rituais.json
            printf '"%s"' "$name" >> rituais.json
            first=0
          done
          printf ']' >> rituais.json
          echo "rituais=$(cat rituais.json)" >> $GITHUB_OUTPUT

  teleporte:
    name: Teleporte
    needs: criacao
    if: needs.criacao.outputs.rituais != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Tutor-Demon√≠aco
      - uses: dart-lang/setup-dart@v1
      - run: dart pub get
      - run: dart run bin/genesis.dart
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: artefatos/${{ matrix.ritual }}.dart
          retention-days: 1
          if-no-files-found: error

  oraculo:
    name: Or√°culo
    needs: [criacao, teleporte]
    if: needs.criacao.outputs.rituais != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: LIMBO
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: lib/limbo/
      - run: |
          mkdir -p lib/infernus
          if ! dart analyze --fatal-infos lib/limbo/${{ matrix.ritual }}.dart; then
            cp lib/limbo/${{ matrix.ritual }}.dart lib/infernus/
            git config user.name "ritual-bot"
            git config user.email "ritual@bot.com"
            git add lib/infernus/${{ matrix.ritual }}.dart
            echo "- ${{ matrix.ritual }} (falha: $(date))" >> README.md
            git add README.md
            git commit -m "‚ö†Ô∏è ${{ matrix.ritual }} enviado ao infernus"
            git push origin LIMBO
          fi
      - name: Renomear original para _infernus em Tutor-Demon√≠aco
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ matrix.ritual }}';
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}_infernus`,
              message: `‚ö†Ô∏è ${nome} marcado como infernus`,
              content: Buffer.from('').toString('base64'),
              branch: 'Tutor-Demon√≠aco'
            });
            await github.rest.repos.deleteFile({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}.txt`,
              message: `üóëÔ∏è ${nome}.txt removido (infernus)`,
              branch: 'Tutor-Demon√≠aco',
              sha: (await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: `recipe/${nome}.txt`,
                ref: 'Tutor-Demon√≠aco'
              })).data.sha
            });

  selo:
    name: Selo
    needs: oraculo
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Tutor-Demon√≠aco
      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: artefatos/
      - id: tipo
        run: |
          # Define branch destino pelo conte√∫do do .txt (primeira linha)
          tipo=$(head -n1 recipe/${{ matrix.ritual }}.txt | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z]//g')
          case "$tipo" in
            instrumento|instrumentos|magicos) echo "branch=Instrumentos-M√°gicos" >> $GITHUB_OUTPUT ;;
            grimorio|grimoÃÅrio|magia)        echo "branch=GRIMORIO"           >> $GITHUB_OUTPUT ;;
            extraplanar|extraplanares)       echo "branch=ExtraPlanares"       >> $GITHUB_OUTPUT ;;
            *)                               echo "branch=Instrumentos-M√°gicos" >> $GITHUB_OUTPUT ;;
          esac
      - name: Mover artefato para branch respectiva
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const nome   = '${{ matrix.ritual }}';
            const branch = '${{ steps.tipo.outputs.branch }}';
            const content= fs.readFileSync(`artefatos/${nome}.dart`, 'utf8');
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `${nome}.dart`,
              message: `‚úÖ Selo: ${nome} promovido para ${branch}`,
              content: Buffer.from(content).toString('base64'),
              branch: branch
            });
      - name: Mover .txt para recipes/acervo (sem extens√£o)
        uses: actions/github-script@v7
        with:
          script: |
            const nome = '${{ matrix.ritual }}';
            const txt  = (await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}.txt`,
              ref: 'Tutor-Demon√≠aco'
            })).data;
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipes/acervo/${nome}`,
              message: `üì¶ ${nome} arquivado em acervo`,
              content: txt.content,
              branch: 'Tutor-Demon√≠aco'
            });
            await github.rest.repos.deleteFile({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: `recipe/${nome}.txt`,
              message: `üóëÔ∏è ${nome}.txt movido para acervo`,
              branch: 'Tutor-Demon√≠aco',
              sha: txt.sha
            });

  ascensao:
    name: Ascens√£o
    needs: selo
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Tutor-Demon√≠aco
      - name: Registro em Tutor-Demon√≠aco
        run: echo "- ${{ matrix.ritual }}" >> README.md
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '‚úÖ Ascens√£o: ${{ matrix.ritual }} registrado'
          branch: Tutor-Demon√≠aco

      - uses: actions/checkout@v4
        with:
          ref: LIMBO
      - name: Registro em LIMBO
        run: |
          echo "- ${{ matrix.ritual }} ‚Äì plugin funcional" >> README.md
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '‚úÖ Ascens√£o: ${{ matrix.ritual }} descri√ß√£o adicionada'
          branch: LIMBO
