# ‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì
# ‚îÉ üîÆ genesis.yml ‚Äì Ritual por ritual: artefato nomeado pelo .txt real         ‚îÉ
# ‚îÉ üìú byThyrrel | Jobs: Cria√ß√£o, Teleporte, Or√°culo, Selo, Ascens√£o          ‚îÉ
# ‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ
name: Genesis Ritual

on:
  push:
    branches: [Tutor-Demon√≠aco]
    paths: [recipe/**, bin/genesis.dart, .github/workflows/genesis.yml]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  criacao:
    name: Cria√ß√£o
    runs-on: ubuntu-latest
    outputs:
      rituais: ${{ steps.set.outputs.rituais }}
    steps:
      - uses: actions/checkout@v4
      - id: set
        run: |
          # Lista arquivos .txt e gera JSON array com awk (sem jq)
          ls recipe/*.txt 2>/dev/null | awk '{gsub(/\.txt$/,"", $0); gsub(/.*\//,"", $0); printf "\"%s\",", $0}' | \
          awk '{print "[" substr($0,1,length($0)-1) "]"}' > rituais.json
          echo "rituais=$(cat rituais.json)" >> $GITHUB_OUTPUT

  teleporte:
    name: Teleporte
    needs: criacao
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - run: dart pub get
      - run: dart run bin/genesis.dart
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: artefatos/${{ matrix.ritual }}.dart
          retention-days: 1
          if-no-files-found: error

  oraculo:
    name: Or√°culo
    needs: [criacao, teleporte]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: artefatos/
      - run: |
          mkdir -p lib/infernus
          if ! dart analyze --fatal-infos artefatos/${{ matrix.ritual }}.dart; then
            cp artefatos/${{ matrix.ritual }}.dart lib/infernus/
            [ -f "recipe/${{ matrix.ritual }}.txt" ] && mv "recipe/${{ matrix.ritual }}.txt" "recipe/${{ matrix.ritual }}_infernus"
          fi

  selo:
    name: Selo
    needs: oraculo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir -p .github/workflows
          echo "# Job gerado automaticamente" >> .github/workflows/conjurafor.yml

  ascensao:
    name: Ascens√£o
    needs: selo
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ritual: ${{ fromJson(needs.criacao.outputs.rituais) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ritual }}
          path: artefatos/
      - run: |
          mkdir -p instrumento ritual extraplanar
          cp artefatos/${{ matrix.ritual }}.dart instrumento/
          cp artefatos/${{ matrix.ritual }}.dart ritual/
          cp artefatos/${{ matrix.ritual }}.dart extraplanar/
      - run: echo "- ${{ matrix.ritual }}" >> README.md
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '‚úÖ Ascens√£o: ${{ matrix.ritual }} promovido'
          branch: Tutor-Demon√≠aco
