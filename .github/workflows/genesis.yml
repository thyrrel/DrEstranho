# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ ⚙️ genesis_ritual.yml - Ritual completo: invocação, validação e promoção  ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

name: Genesis Ritual

on:
  workflow_dispatch:  # Permite execução manual via navegador
  push:
    paths:
      - 'Tutor-Demoníaco/recipes/**'
      - 'bin/genesis.dart'

jobs:
  invocar_e_validar:
    name: 🔮 Invocação, Validação e Destino
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout do grimório
        uses: actions/checkout@v3

      - name: 🧙 Instalar Dart
        uses: dart-lang/setup-dart@v1

      - name: 📦 Instalar dependências
        run: dart pub get

      - name: 🔮 Executar rituais .txt válidos
        run: |
          rituais=$(find Tutor-Demoníaco/recipes -type f -name '*.txt' ! -name '*infernus.txt' ! -name '*acervo.txt')

          for ritual in $rituais; do
            nome=$(basename "$ritual" .txt)
            artefato="artefatos/$nome.dart"

            echo "🔧 Gerando artefato para $ritual"
            dart run bin/genesis.dart "$ritual"

            if [ -f "$artefato" ]; then
              echo "🧪 Testando artefato: $artefato"
              dart analyze "$artefato" || STATUS=falhou

              mkdir -p LIMBO/lib/limbo/
              mkdir -p LIMBO/lib/infernus/

              if [ "$STATUS" = "falhou" ]; then
                mv "$artefato" LIMBO/lib/infernus/
                mv "$ritual" "Tutor-Demoníaco/recipes/${nome}infernus.txt"
                echo "❌ Ritual reprovado: $nome → infernus"
              else
                mv "$artefato" LIMBO/lib/limbo/
                echo "✅ Ritual aprovado: $nome → limbo"

                tipo=$(grep "^tipo:" "$ritual" | cut -d':' -f2 | tr -d '[:space:]')
                echo "🚀 Invocando destino final: $tipo"

                destino=""
                case "$tipo" in
                  instrumento)
                    destino="Instrumentos-Mágicos"
                    ;;
                  grimorio)
                    destino="GRIMORIO"
                    ;;
                  extraplanar)
                    destino="ExtraPlanares"
                    ;;
                  *)
                    echo "⚠️ Tipo desconhecido: $tipo"
                    continue
                    ;;
                esac

                mkdir -p "$destino/lib/$tipo/"
                mv "LIMBO/lib/limbo/$nome.dart" "$destino/lib/$tipo/"
                echo "📦 Artefato movido para $destino/lib/$tipo/"

                mkdir -p Tutor-Demoníaco/recipes/acervo/
                mv "$ritual" "Tutor-Demoníaco/recipes/acervo/${nome}acervo.txt"
                echo "📁 Ritual arquivado: ${nome}acervo.txt"
              fi
            else
              echo "⚠️ Nenhum artefato gerado para $nome"
            fi
          done
