# ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
# ┃ 🔮 genesis.yml - Ritual de geração de artefatos por receita individual     ┃
# ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

name: Genesis Ritual

on:
  push:
    paths:
      - 'recipes/**'
      - 'bin/tutor.dart'
      - 'lib/tutor/**'
      - '.github/workflows/genesis.yml'

jobs:
  preparar_matrix:
    runs-on: ubuntu-latest
    outputs:
      arquivos: ${{ steps.listar.outputs.arquivos }}
    steps:
      - name: 📦 Checkout do grimório
        uses: actions/checkout@v3

      - name: 📜 Instalar utilitários necessários
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 📜 Listar arquivos em /recipes/
        id: listar
        run: |
          ARTEFATOS=$(find recipes -type f -name '*.txt' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          if [ -z "$ARTEFATOS" ] || [ "$ARTEFATOS" = "null" ]; then
            ARTEFATOS="[]"
          fi
          echo "arquivos=$ARTEFATOS" >> $GITHUB_OUTPUT

  gerar_artefatos:
    needs: preparar_matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arquivo: ${{ fromJson(needs.preparar_matrix.outputs.arquivos) }}

    steps:
      - name: 📦 Checkout do grimório
        uses: actions/checkout@v3

      - name: 🧙 Instalar Dart
        uses: dart-lang/setup-dart@v1

      - name: 📦 Instalar dependências
        run: dart pub get

      - name: 🔮 Gerar artefato
        run: dart run bin/tutor.dart "${{ matrix.arquivo }}"

      - name: 📁 Mover artefato para LIMBO
        run: |
          nome=$(basename "${{ matrix.arquivo }}" .txt)
          mkdir -p lib/limbo/
          if [ -f "artefatos/$nome.dart" ]; then
            mv -f "artefatos/$nome.dart" lib/limbo/
            echo "✅ Artefato $nome.dart movido para lib/limbo/"
          else
            echo "⚠️ Artefato não encontrado: artefatos/$nome.dart"
          fi
